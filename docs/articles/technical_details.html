<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technical details • SpikeInference</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Technical details">
<meta property="og:description" content="SpikeInference">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SpikeInference</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/technical_details.html">Technical details</a>
</li>
<li>
  <a href="../articles/Tutorials.html">Software tutorials</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="technical_details_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Technical details</h1>
            
      
      
      <div class="hidden name"><code>technical_details.Rmd</code></div>

    </div>

    
    
<center>
<div class="figure">
<img src="../man/figures/combined_plot_exp_7_cell_29_paper_example.png" style="width:80.0%" alt=""><p class="caption">Figure 1: Illustrative example for recording 29 from Chen et al. (2013), which uses the GCaMP6f indicator. The cell’s fluorescence trace is displayed in gray. Spikes estimated via the <span class="math inline">\(\ell_0\)</span> problem are displayed in orange; the spikes with <em>selective</em> <span class="math inline">\(p\)</span>-values below <span class="math inline">\(0.05\)</span> (with <span class="math inline">\(h=20\)</span>) are displayed in blue; and the true spike times are shown in black.</p>
</div>
</center>
<div id="overview" class="section level3">
<h3 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h3>
<p>Calcium imaging is an increasingly popular technique in neuroscience for recording the activity of large populations of neurons <em>in vivo</em>. When a neuron spikes, calcium floods the cell. Due to the use of fluorescent calcium indicators, this leads to a rapid increase in calcium. Therefore, for each neuron, calcium imaging results in a time series of fluorescence intensities that can be seen as a first-order approximation to its unobserved spike times. As an example, we plot one such recording in grey (see Figure 1). Typically, the scientific interest lies in the unobserved spike times, rather than the observed fluorescence traces.</p>
<p>After we estimated spikes from the calcium imaging data, it’s natural to want to test whether the estimated spikes correspond to a true increase in calcium. However, a naive approach that doesn’t account for the fact that the spikes are estimated from the <em>same data used for testing</em> will lead to inflated selective Type I error — that is, the probability of falsely rejecting the null hypothesis, <em>given that we decided to conduct the test</em>.</p>
<p>To tackle this problem, we propose a selective inference framework to compute valid <span class="math inline">\(p\)</span>-values for hypotheses involving the estimated spikes. In a nutshell, we compute the probability of observing such a large increase in fluorescence under the null hypothesis, <em>given that we estimated a spike at this position</em>. In addition, we develop a computationally-efficient implementation of this framework in the case of the <span class="math inline">\(\ell_0\)</span> spike detection algorithm.</p>
<p>In this tutorial, we illustrate a test of the null hypothesis that the calcium is decaying exponentially (i.e., there are no true spikes) near spikes estimated via an <span class="math inline">\(\ell_0\)</span> penalized problem. Details for our method can be found in our manuscript at <a href="https://arxiv.org/abs/2103.07818">https://arxiv.org/abs/2103.07818</a>.</p>
</div>
<div id="model-setup" class="section level3">
<h3 class="hasAnchor">
<a href="#model-setup" class="anchor"></a>Model setup</h3>
<p>We consider the AR(1) generative model <span class="math display">\[Y_t = c_t + \epsilon_t, \epsilon_t \sim N(0, \sigma^2), \; t = 1,\ldots, T,\]</span> where <span class="math display">\[c_t = \gamma  c_{t-1} + z_t, z_t\geq 0,  \; t = 2,\ldots, T.\]</span> In words, this says that when <span class="math inline">\(z_t=0\)</span>, calcium decays exponentially at a (known) rate <span class="math inline">\(\gamma\in(0,1)\)</span>. If <span class="math inline">\(z_t&gt;0\)</span>, then there is a spike at the <span class="math inline">\(t\)</span>th timestep. We denote the locations of true spikes, <span class="math inline">\(\{t:z_t&gt; 0\}\)</span>, as <span class="math inline">\(\{\tau_1,\ldots, \tau_K\}\)</span>. Without loss of generality, we assume that <span class="math inline">\(\tau_1 &lt; \ldots &lt; \tau_K\)</span>, and we use the convention that <span class="math inline">\(\tau_0 =0\)</span> and <span class="math inline">\(\tau_{K+1} = T\)</span>.</p>
<div id="ell_0-spike-estimation" class="section level4">
<h4 class="hasAnchor">
<a href="#ell_0-spike-estimation" class="anchor"></a><span class="math inline">\(\ell_0\)</span> spike estimation</h4>
<p>We estimate spikes based on noisy observations <span class="math inline">\(y_t, t = 1, \ldots, T\)</span> by solving the <span class="math inline">\(\ell_0\)</span> penalized optimization problem: <span class="math display">\[\begin{equation}
 \text{minimize}_{c_1,...,c_T\geq 0} \left\{\frac{1}{2}\sum_{t=1}^T ( y_t - c_t )^2 + \lambda \sum_{t=2}^T 
 1(c_t \neq \gamma c_t-1) \right\}.
\label{eq:ell_0}
\end{equation}\]</span></p>
<p>Estimated spikes correspond to the timepoints at which the estimated calcium <span class="math inline">\(\hat{c}_t\)</span> does not decay exponentially, i.e., <span class="math inline">\(\{\hat{\tau}_1,\ldots,\hat{\tau}_{\hat{K}}\} = \{t: \hat{c}_{t+1} -\gamma \hat{c}_{t} \neq 0\}\)</span>, where <span class="math inline">\(\hat{K}\)</span> is the number of estimated spikes. Moreover, in practice, we are only interested in estimated spikes associated with an <em>increase</em> (as opposed to a decrease) in estimated calcium.</p>
</div>
</div>
<div id="inference-for-the-presence-of-spikes" class="section level3">
<h3 class="hasAnchor">
<a href="#inference-for-the-presence-of-spikes" class="anchor"></a>Inference for the presence of spikes</h3>
<p>To quantify the uncertainty of these estimates, we test the null hypothesis that the calcium in the neighborhood of an estimated spikes decays exponentially. In particular, consider the <span class="math inline">\(j\)</span>th estimated spike location, denoted as <span class="math inline">\(\hat\tau_j\)</span>, under a simple assumption that there are no spikes within a window of <span class="math inline">\(+h\)</span> and <span class="math inline">\(-h\)</span> of <span class="math inline">\(\hat\tau_j\)</span>. Then we wish to test the null hypothesis <span class="math display">\[\begin{equation}
  H_0: \nu^\top c=0 \mbox{ versus } H_1: \nu^\top c &gt; 0,
    \label{eq:null-nu}
  \end{equation}\]</span> where <span class="math display">\[\nu_{t} = 
\begin{cases}
- \frac{\gamma (\gamma^2-1)}{\gamma^2-\gamma^{-2h+2}}    \gamma^{t-\hat\tau_j}    , &amp; \hat\tau_j-h+1 \leq  t \leq \hat\tau_j, \\
\frac{\gamma^2 -1 }{\gamma^{2h}-1} \gamma^{t-(\hat\tau_j+1)}   , &amp; \hat\tau_j + 1\leq t \leq \hat\tau_j+h,\\
 0, &amp; \text{ otherwise. } \\
\end{cases}\]</span></p>
<p>In a nutshell, the definition of <span class="math inline">\(\nu\)</span> above accounts for the underlying AR(1) mean structure of <span class="math inline">\(c_t\)</span>. More intuition can be found in Section 2.1 of our manuscript (Chen et al. 2021). Intuitively, larger values of <span class="math inline">\(h\)</span> corresponds to more data used to test the null hypothesis of interest, resulting in larger power. However, when <span class="math inline">\(h\)</span> is larger, <span class="math inline">\(H_0\)</span> is also less likely to hold for the same estimated spike location <span class="math inline">\(\hat\tau_j\)</span>.</p>
<p>Now suppose that we test for the presence of a spike only at timepoints at a given timepoint if</p>
<ol style="list-style-type: decimal">
<li>we estimate a spike, and</li>
<li>there is an increase in fluorescence at that timepoint.</li>
</ol>
<p>This results in a challenging selective inference problem: we need to account for the process that led us to estimate a spike this timepoint!</p>
<p>This motivates the following <span class="math inline">\(p\)</span>-value: <span class="math display">\[\mathbb{P}_{H_0}\left(\nu^{\top} Y \geq \nu^{\top} y \;\middle\vert\; \hat\tau_j \in \mathcal{M}(Y) , \nu^{\top}Y &gt; 0, \Pi_{\nu}^{\perp} Y= \Pi_{\nu}^{\perp} \right),\]</span> where <span class="math inline">\(\mathcal{M}(y)\)</span> denotes the set of spikes estimated from <span class="math inline">\(y\)</span> via the <span class="math inline">\(\ell_0\)</span> problem; and <span class="math inline">\(\Pi_{\nu}^{\perp}\)</span> is an orthogonal projection operator used to eliminate nuisance parameters. We show that this <span class="math inline">\(p\)</span>-value for testing <span class="math inline">\(H_0\)</span> can be written as <span class="math display">\[\mathbb{P}\left(\phi \geq \nu^\top y \; \middle|\;  \hat{\tau}_j \in \mathcal{M}(y'(\phi)), \phi\geq 0\right),\]</span> where <span class="math inline">\(\phi\sim \mathcal{N}(0,\sigma^2||\nu||_2^2)\)</span>, and <span class="math display">\[y'(\phi) = \Pi_{\nu}^{\perp}y+\phi\cdot \frac{\nu}{||\nu||_2^2} = y+\left(\frac{\phi-\nu^{\top}y}{||\nu||_2^2}\right)\nu\]</span> is a perturbation of the observed data <span class="math inline">\(y\)</span>, along the direction of <span class="math inline">\(\nu\)</span>.</p>
<p>Moreover, if we denote <span class="math inline">\(\mathcal{S}=\{\phi: \hat\tau_j \in \mathcal{M}(y'(\phi))\}\)</span>, the <span class="math inline">\(p\)</span>-value can be equivalently expressed as <span class="math display">\[\mathbb{P}\left(\phi \geq \nu^\top y \;\middle |\; \phi \in \mathcal{S}\cap(0,\infty)\right).\]</span> Now since <span class="math inline">\(\phi\sim \mathcal{N}(0,\sigma^2||\nu||_2^2)\)</span>, it follows that <span class="math inline">\(\phi \;|\; \phi \in \mathcal{S}\cap(0,\infty))\)</span> will follow a truncated normal distribution. Thus the computation of the <span class="math inline">\(p\)</span>-value boils down to characterizing the set <span class="math inline">\(\mathcal{S}\)</span>.</p>
<p>Our software implements an efficient calculation of this <span class="math inline">\(p\)</span>-value by analytically characterizing the set <span class="math inline">\(\mathcal{S}\)</span>. The resulting <span class="math inline">\(p\)</span>-value will control the selective Type I error, in the sense of Lee et al. (2016) and Fithian et al. (2014). Additional details can be found in Sections 2 and 3 of our paper (Chen et al. 2021)).</p>
<p>Remark: by contrast, a naive (Wald) <span class="math inline">\(p\)</span>-value takes the form <span class="math display">\[\mathbb{P}\left(\phi \geq \nu^\top y \right).\]</span> This approach will not control the selective Type I error, i.e., it will reject <span class="math inline">\(H_0\)</span> too often when we test <span class="math inline">\(H_0\)</span> for spikes estimated from the data.</p>
</div>
<div id="extensions" class="section level3">
<h3 class="hasAnchor">
<a href="#extensions" class="anchor"></a>Extensions</h3>
<p>Our software also allows for the following extensions:</p>
<ol style="list-style-type: decimal">
<li>Generate <span class="math inline">\((1-\alpha)\)</span> selective confidence intervals for the parameter <span class="math inline">\(\nu^\top c\)</span>, the change in calcium associated with an estimated spike.</li>
</ol>
</div>
<div id="references" class="section level3">
<h3 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h3>
<p>Chen T-W, Wardill TJ, Sun Y, Pulver SR, Renninger SL, Baohan A, Schreiter ER, Kerr RA, Orger MB, Jayaraman V, Looger LL, Svoboda K, Kim DS. Ultrasensitive fluorescent proteins for imaging neuronal activity. Nature. 2013;499(7458):295-300. <a href="doi:10.1038/nature12354" class="uri">doi:10.1038/nature12354</a></p>
<p>Chen YT, Jewell SW, Witten DM. (2021) Quantifying uncertainty in spikes estimated from calcium imaging data. <a href="https://arxiv.org/abs/2103.07818">arXiv:2103.0781</a> [statME].</p>
<p>Lee JD, Sun DL, Sun Y, Taylor JE. Exact post-selection inference, with application to the lasso. Ann Stat. 2016;44(3):907-927. <a href="doi:10.1214/15-AOS1371" class="uri">doi:10.1214/15-AOS1371</a></p>
<p>Fithian W, Sun D, Taylor J. (2014) Optimal Inference After Model Selection. arXiv:1410.2597 [mathST].</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><div class="copyright">
  <p>Developed by Yiqun Chen, Sean Jewell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
